env:
  global:
    - NODE_VERSION=10

stages:
  # - name: tests_and_lint
  # - name: e2e_ios
  - name: e2e_android

jobs:
  include:
    #
    # Run Jest test, Typescript check, ESlint and DangerJS
    #
    # - stage: tests_and_lint
    #   language: node_js
    #   cache: npm
    #   install:
    #     - . ./scripts/ci/install.nvm.sh
    #     - npm install >/dev/null 2>&1
    #   script:
    #     - yarn test
    #     - yarn tsc
    #     - yarn lint
    #     - yarn danger ci
    #
    # E2E test for iOS
    #
    # - stage: e2e_ios
    #   language: objective-c
    #   addons:
    #     homebrew:
    #       packages:
    #         - applesimutils
    #       taps: wix/brew
    #   os: osx
    #   osx_image: xcode11.6
    #   cache:
    #     directories:
    #       - node_modules
    #   install:
    #     - . ./scripts/ci/install.nvm.sh
    #     - gem install xcpretty >/dev/null 2>&1
    #     - gem install xcpretty-travis-formatter >/dev/null 2>&1
    #     - npm install >/dev/null 2>&1
    #     - cd ios; pod install >/dev/null 2>&1; cd ..;
    #   script:
    #     - ./scripts/ci/detox.ios.sh
    #
    # E2E test for Android
    #
    - stage: e2e_android
      language: android
      env:
        # Project versions
        - COMPILE_API=28
        - ANDROID_BUILD_TOOLS=28.0.3
        - API=28
        # Emulator stuffs
        - ADB_INSTALL_TIMEOUT=8
        - ABI=x86_64
        - EMU_FLAVOR=default
        # Paths
        - ANDROID_HOME=/usr/local/android-sdk
        - TOOLS=${ANDROID_HOME}/tools
        - PATH=${ANDROID_HOME}:${ANDROID_HOME}/emulator:${TOOLS}:${TOOLS}/bin:${ANDROID_HOME}/platform-tools:${PATH}
      cache:
        directories:
          - node_modules
      jdk:
        - oraclejdk8
      android:
        components:
          - tools
      install:
        - echo 'count=0' > /home/travis/.android/repositories.cfg # Avoid harmless sdkmanager warning
        - echo y | sdkmanager "platform-tools" >/dev/null
        - echo y | sdkmanager "tools" >/dev/null # A second time per Travis docs, gets latest versions
        - echo y | sdkmanager "build-tools;$ANDROID_BUILD_TOOLS" >/dev/null # Implicit gradle dependency - gradle drives changes
        - echo y | sdkmanager "platforms;android-$API" >/dev/null # We need the API of the emulator we will run
        - echo y | sdkmanager "platforms;android-$COMPILE_API" >/dev/null # We need the API of the current compileSdkVersion from gradle.properties
        - echo y | sdkmanager --channel=4 "emulator" # Experiment with canary, specifying 28.0.3 (prior version) did not work
        - echo y | sdkmanager "extras;android;m2repository" >/dev/null
        - echo y | sdkmanager "system-images;android-$API;$EMU_FLAVOR;$ABI" #>/dev/null # install our emulator

        - ./scripts/ci/emulator.android.sh

        - . ./scripts/ci/install.nvm.sh
        - npm install >/dev/null 2>&1
      script:
        - ./scripts/ci/detox.android.sh
